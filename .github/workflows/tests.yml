name: Run Behave Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install behave selenium
        
    - name: Create custom step for opening URLs
      run: |
        mkdir -p isitchristmas/features/steps
        cat > isitchristmas/features/steps/custom_steps.py << 'STEPEOF'
        from behave import given, when, then
        from selenium.webdriver.common.by import By
        from selenium.webdriver.support.ui import WebDriverWait
        from selenium.webdriver.support import expected_conditions as EC
        
        @given('I open the url "{url}"')
        def step_open_url(context, url):
            context.driver.get(url)
        
        @when('I open the url "{url}"')
        def step_when_open_url(context, url):
            context.driver.get(url)
        
        @then('I expect that element "{selector}" contains the text "{text}"')
        def step_element_contains_text(context, selector, text):
            element = context.driver.find_element(By.CSS_SELECTOR, selector)
            assert text in element.text, f"Expected '{text}' in element text, but got '{element.text}'"
        
        @then('I expect that the title is "{title}"')
        def step_title_is(context, title):
            assert context.driver.title == title, f"Expected title '{title}', but got '{context.driver.title}'"
        
        @then('I expect that element "{selector}" does exist')
        def step_element_exists(context, selector):
            element = context.driver.find_element(By.CSS_SELECTOR, selector)
            assert element is not None
        
        @then('I expect that element "{selector}" is visible')
        def step_element_visible(context, selector):
            element = context.driver.find_element(By.CSS_SELECTOR, selector)
            assert element.is_displayed()
        
        @then('I expect that the url is "{url}"')
        def step_url_is(context, url):
            assert context.driver.current_url == url, f"Expected URL '{url}', but got '{context.driver.current_url}'"
        
        @then('I expect that element "{selector}" contains any text')
        def step_element_has_text(context, selector):
            element = context.driver.find_element(By.CSS_SELECTOR, selector)
            assert len(element.text) > 0
        
        @when('I pause for {milliseconds}ms')
        def step_pause(context, milliseconds):
            import time
            time.sleep(int(milliseconds) / 1000.0)
        STEPEOF
        
    - name: Create modified environment.py for CI
      run: |
        cat > isitchristmas/features/environment.py << 'ENVEOF'
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        
        def before_all(context):
            chrome_options = Options()
            chrome_options.add_argument('--headless')
            chrome_options.add_argument('--no-sandbox')
            chrome_options.add_argument('--disable-dev-shm-usage')
            chrome_options.add_argument('--disable-gpu')
            context.driver = webdriver.Chrome(options=chrome_options)
        
        def after_all(context):
            if hasattr(context, 'driver'):
                context.driver.quit()
        ENVEOF
        
    - name: Run behave tests for isitchristmas
      run: |
        cd isitchristmas && behave --no-capture
      continue-on-error: true
        
    - name: Create custom steps for peppers-ghost
      run: |
        if [ -d peppers-ghost/features ]; then
          mkdir -p peppers-ghost/features/steps
          cp isitchristmas/features/steps/custom_steps.py peppers-ghost/features/steps/
          cat > peppers-ghost/features/environment.py << 'ENVEOF'
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        
        def before_all(context):
            chrome_options = Options()
            chrome_options.add_argument('--headless')
            chrome_options.add_argument('--no-sandbox')
            chrome_options.add_argument('--disable-dev-shm-usage')
            chrome_options.add_argument('--disable-gpu')
            context.driver = webdriver.Chrome(options=chrome_options)
        
        def after_all(context):
            if hasattr(context, 'driver'):
                context.driver.quit()
        ENVEOF
        fi
        
    - name: Run behave tests for peppers-ghost
      run: |
        if [ -d peppers-ghost/features ]; then
          cd peppers-ghost && behave --no-capture
        fi
      continue-on-error: true
